name: Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-west-2

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      services: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed services
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'src/frontend/**'
            cartservice:
              - 'src/cartservice/**'
            productcatalogservice:
              - 'src/productcatalogservice/**'
            currencyservice:
              - 'src/currencyservice/**'
            paymentservice:
              - 'src/paymentservice/**'
            shippingservice:
              - 'src/shippingservice/**'
            checkoutservice:
              - 'src/checkoutservice/**'
            emailservice:
              - 'src/emailservice/**'
            recommendationservice:
              - 'src/recommendationservice/**'
            adservice:
              - 'src/adservice/**'
            shoppingassistantservice:
              - 'src/shoppingassistantservice/**'
            loadgenerator:
              - 'src/loadgenerator/**'

  build-and-push:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.services != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::183631345736:role/githubaction-fullstack-sre
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set build context
        id: context
        run: |
          case "${{ matrix.service }}" in
            frontend) echo "path=src/frontend" >> $GITHUB_OUTPUT ;;
            cartservice) echo "path=src/cartservice/src" >> $GITHUB_OUTPUT ;;
            productcatalogservice) echo "path=src/productcatalogservice" >> $GITHUB_OUTPUT ;;
            currencyservice) echo "path=src/currencyservice" >> $GITHUB_OUTPUT ;;
            paymentservice) echo "path=src/paymentservice" >> $GITHUB_OUTPUT ;;
            shippingservice) echo "path=src/shippingservice" >> $GITHUB_OUTPUT ;;
            checkoutservice) echo "path=src/checkoutservice" >> $GITHUB_OUTPUT ;;
            emailservice) echo "path=src/emailservice" >> $GITHUB_OUTPUT ;;
            recommendationservice) echo "path=src/recommendationservice" >> $GITHUB_OUTPUT ;;
            adservice) echo "path=src/adservice" >> $GITHUB_OUTPUT ;;
            shoppingassistantservice) echo "path=src/shoppingassistantservice" >> $GITHUB_OUTPUT ;;
            loadgenerator) echo "path=src/loadgenerator" >> $GITHUB_OUTPUT ;;
          esac

      - name: Build and push ${{ matrix.service }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          SERVICE: ${{ matrix.service }}
          CONTEXT: ${{ steps.context.outputs.path }}
        run: |
          IMAGE_REPO="$ECR_REGISTRY/$SERVICE"
          IMAGE_TAG="${GITHUB_SHA::7}"
          
          echo "Building $SERVICE from $CONTEXT"
          
          docker buildx build \
            --platform=linux/amd64 \
            --file=$CONTEXT/Dockerfile \
            --tag=$IMAGE_REPO:$IMAGE_TAG \
            --tag=$IMAGE_REPO:latest \
            --cache-from=type=registry,ref=$IMAGE_REPO:buildcache \
            --cache-to=type=registry,ref=$IMAGE_REPO:buildcache,mode=max \
            --push \
            $CONTEXT
          
          echo "âœ… Successfully built and pushed $SERVICE:$IMAGE_TAG"